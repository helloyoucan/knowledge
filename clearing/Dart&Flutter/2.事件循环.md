### Dart单线程

>  核心：主线程、微任务、宏任务

- 主线程：执行业务逻辑、网络I/O、本地文件I/O、事件循环等相关任务事件，应用时间驱动方式执行。
- 微任务队列：包含Dart内部的微任务，主要通过sheduleMicrotask来调度。
- 事件队列：包含外部事件，例如I/O、Timer、绘制事件等。



#### 事件循环

1. 执行main函数，产生微任务队列和事件任务队列
2. 判断是否有微任务，有则执行，执行完再次判断执行
3. 没有可执行的微任务，则判断是否存在事件任务，无则方法判断是否存在微任务
4. 在微任务和事件任务执行时，可能会产生微任务和事件任务，所以需要再次判断啥时候需要插入微任务队列和事件任务队列



![](http://qeafqm9zu.bkt.clouddn.com/imgs/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.png)

```dart
import 'dart:async';
void main() {
	print('flow start'); // 执行打印开始 
	// 执行判断为事件任务，添加到事件任务队列
	Timer.run((){ 
       print('event'); // 执行事件任务，打印标记
   	});
   	// 执行判断为微任务，添加到微任务队列 
	scheduleMicrotask((){ 
        print('microtask'); // 执行微任务，打印标记
    });
	print('flow end'); // 打印结束标记
}
/*
首先主线程逻辑，执行打印 start ；
执行 Timer，为事件任务，将其增加到事件任务队列中；
执行 scheduleMicrotask，为微任务队列，将其增加到微任务队列中；
执行打印 flow end；
判断是否存在微任务队列，存在则执行微任务队列，打印 mcrotask；
判断是否还存在微任务队列，无则判断是否存在事件任务队列，存在执行事件任务队列，打印 event。
运行结果：
flow start
flow end
microtask
event
*/
```

#### lsolate多线程

 Dart 的单线程叫作 isolate 线程，每个 isolate 线程之间是不共享内存的，通过消息机制通信。

```dart
import 'dart:async';
import 'dart:isolate';
Isolate isolate;
String name = 'dart';
void main() {
	// 执行新线程创建函数
 	isolateServer();
}
/// 多线程函数
void isolateServer()async{
	// 创建新的线程，并且执行回调 changName 
	final receive = ReceivePort();
	isolate = await Isolate.spawn(changName, receive.sendPort);
	// 监听线程返回信息 
	receive.listen((data){
		print("Myname is $data"); // 打印线程返回的数据
		print("Myname is $name"); // 打印全局 name 的数据
	});
}
/// 线程回调处理函数
void changName(SendPort port){
	name = 'dart isloate'; // 修改当前全局 name 属性
	port.send(name); // 将当前name发送给监听方
	print("Myname is $name in isloate"); // 打印当前线程中的 name
}
/*
import 对应的库；
声明两个变量，一个是 isolate 对象，一个是字符串类型的 name；
执行 main 函数，main 函数中执行 isolateServer 异步函数；
isolateServer 中创建了一个 isolate 线程，创建线程时候，可以传递接受回调的函数 changName；
在 changName 中修改当前的全局变量 name ，并且发送消息给到接收的端口，并且打印该线程中的 name 属性；
isolateServer 接收消息，接收消息后打印返回的数据和当前 name 变量。
*/
```

